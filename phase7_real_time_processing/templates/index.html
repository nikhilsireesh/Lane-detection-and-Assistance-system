<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó Lane Detection - Real-time Processing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-section {
            text-align: center;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6fffa;
        }

        .upload-icon {
            font-size: 3em;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .upload-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            background: #f7fafc;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .progress-section {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #4a5568;
            font-size: 0.9em;
        }

        .video-result {
            text-align: center;
            margin-top: 20px;
        }

        .video-player {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .upload-text {
            color: #718096;
            font-size: 1.1em;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .camera-section {
            text-align: center;
        }

        .camera-feed {
            width: 100%;
            max-width: 640px;
            height: auto;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .camera-placeholder {
            width: 100%;
            height: 300px;
            background: #f0f0f0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .results-section {
            grid-column: 1 / -1;
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            text-align: center;
        }

        .result-item h3 {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .result-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stats-section {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.1);
            color: white;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #90cdf4;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #e53e3e;
        }

        .success {
            background: #c6f6d5;
            color: #2d7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #38a169;
        }

        .download-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #45a049;
            text-decoration: none;
            color: white;
        }

        .download-section {
            text-align: center;
            padding: 10px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Lane Detection & Assistance System</h1>
            <p>Real-time processing with AI-powered driver assistance</p>
        </div>

        <!-- Assistance Dashboard -->
        <div class="assistance-dashboard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
            <h2 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                <span>üö®</span> Driver Assistance Status
                <button onclick="resetAssistance()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px;">Reset Session</button>
            </h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div class="metric-card" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;" id="safety-score">100.0</div>
                    <div style="font-size: 14px; opacity: 0.9;">Safety Score</div>
                </div>
                <div class="metric-card" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;" id="safe-percentage">100%</div>
                    <div style="font-size: 14px; opacity: 0.9;">Safe Driving</div>
                </div>
                <div class="metric-card" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;" id="total-alerts">0</div>
                    <div style="font-size: 14px; opacity: 0.9;">Total Alerts</div>
                </div>
                <div class="metric-card" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 5px;" id="critical-alerts">0</div>
                    <div style="font-size: 14px; opacity: 0.9;">Critical Alerts</div>
                </div>
            </div>
            
            <!-- Current Alert Display -->
            <div id="current-alert" style="background: rgba(0,170,0,0.3); padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #00aa00;">
                <div style="font-size: 18px; font-weight: bold;">‚úÖ SYSTEM READY</div>
                <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">Upload an image or video to begin lane assistance</div>
            </div>
            
            <!-- Recent Alerts -->
            <div style="margin-top: 15px;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px;">Recent Alerts:</h3>
                <div id="recent-alerts" style="max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.1); border-radius: 8px; padding: 10px;">
                    <div style="text-align: center; opacity: 0.7; font-size: 14px;">No alerts yet</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Image Upload Section -->
            <div class="card upload-section">
                <h2>üì§ Upload Media</h2>
                <div class="upload-tabs">
                    <button class="tab-btn active" onclick="switchTab('image')">üì∑ Image</button>
                    <button class="tab-btn" onclick="switchTab('video')">üé• Video</button>
                </div>
                
                <div id="imageTab" class="tab-content active">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">
                            Click to select an image or drag & drop<br>
                            <small>Supported: JPG, PNG, GIF, BMP</small>
                        </div>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                    <button class="btn" onclick="processUploadedImage()">üîç Process Image</button>
                </div>
                
                <div id="videoTab" class="tab-content">
                    <div class="upload-area" id="videoUploadArea" onclick="document.getElementById('videoInput').click()">
                        <div class="upload-icon">üé•</div>
                        <div class="upload-text">
                            Click to select a video or drag & drop<br>
                            <small>Supported: MP4, AVI, MOV, MKV</small>
                        </div>
                    </div>
                    <input type="file" id="videoInput" class="file-input" accept="video/*">
                    <button class="btn" onclick="processUploadedVideo()">üé¨ Process Video</button>
                </div>
                
                <div class="loading" id="uploadLoading">
                    <div class="spinner"></div>
                    <div id="loadingText">Processing...</div>
                </div>
                
                <!-- Video Processing Progress -->
                <div class="progress-section" id="videoProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing video...</div>
                </div>
            </div>

            <!-- Camera Section -->
            <div class="card camera-section">
                <h2>üé• Live Camera</h2>
                <div id="cameraContainer">
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        üìπ Camera feed will appear here
                    </div>
                    <img class="camera-feed" id="cameraFeed" style="display: none;" src="">
                </div>
                <button class="btn" id="startCameraBtn" onclick="startCamera()">‚ñ∂Ô∏è Start Camera</button>
                <button class="btn" id="stopCameraBtn" onclick="stopCamera()" style="display: none;">‚èπÔ∏è Stop Camera</button>
            </div>

            <!-- Results Section -->
            <div class="card results-section" id="resultsSection">
                <h2>üìä Processing Results</h2>
                <div class="results-grid" id="resultsGrid">
                    <!-- Results will be populated here -->
                </div>
                <div id="processingStats"></div>
            </div>

            <!-- Statistics Section -->
            <div class="card stats-section">
                <h2>‚ö° System Statistics</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-item">
                        <div class="stat-value" id="modelStatus">Loading...</div>
                        <div class="stat-label">Model Status</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalProcessed">0</div>
                        <div class="stat-label">Images Processed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgTime">0ms</div>
                        <div class="stat-label">Avg Processing Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="lastTime">0ms</div>
                        <div class="stat-label">Last Processing Time</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let selectedVideo = null;
        let cameraActive = false;
        let currentTab = 'image';

        // Assistance system functions
        function updateAssistanceMetrics() {
            fetch('/assistance/metrics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const metrics = data.metrics;
                        
                        // Update metric displays
                        document.getElementById('safety-score').textContent = metrics.safety_score;
                        document.getElementById('safe-percentage').textContent = metrics.safe_percentage + '%';
                        document.getElementById('total-alerts').textContent = metrics.total_alerts;
                        document.getElementById('critical-alerts').textContent = metrics.critical_alerts;
                        
                        // Update recent alerts
                        const recentAlertsDiv = document.getElementById('recent-alerts');
                        if (data.recent_alerts && data.recent_alerts.length > 0) {
                            recentAlertsDiv.innerHTML = data.recent_alerts.map(alert => 
                                `<div style="margin-bottom: 5px; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 12px;">
                                    <span style="color: ${alert.color};">${alert.message}</span>
                                    <span style="float: right; opacity: 0.7;">${alert.timestamp}</span>
                                </div>`
                            ).join('');
                        } else {
                            recentAlertsDiv.innerHTML = '<div style="text-align: center; opacity: 0.7; font-size: 14px;">No alerts yet</div>';
                        }
                    }
                })
                .catch(error => console.error('Error updating assistance metrics:', error));
        }
        
        function resetAssistance() {
            fetch('/assistance/reset', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('Assistance session reset successfully', 'success');
                        updateAssistanceMetrics();
                        
                        // Reset current alert
                        const currentAlert = document.getElementById('current-alert');
                        currentAlert.style.background = 'rgba(0,170,0,0.3)';
                        currentAlert.style.borderLeftColor = '#00aa00';
                        currentAlert.innerHTML = `
                            <div style="font-size: 18px; font-weight: bold;">‚úÖ SYSTEM READY</div>
                            <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">Upload an image or video to begin lane assistance</div>
                        `;
                    }
                })
                .catch(error => console.error('Error resetting assistance:', error));
        }
        
        function updateAssistanceAlert(assistanceData) {
            if (!assistanceData || !assistanceData.alert) return;
            
            const alert = assistanceData.alert;
            const currentAlert = document.getElementById('current-alert');
            
            // Update alert display
            currentAlert.style.background = `rgba(${hexToRgb(alert.color)}, 0.3)`;
            currentAlert.style.borderLeftColor = alert.color;
            currentAlert.innerHTML = `
                <div style="font-size: 18px; font-weight: bold;">${alert.message}</div>
                <div style="font-size: 14px; margin-top: 5px; opacity: 0.9;">${alert.action}</div>
                <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">Lane Coverage: ${alert.lane_coverage.toFixed(1)}% | Score: ${alert.safety_score}</div>
            `;
            
            // Play sound for critical alerts
            if (alert.level === 'critical') {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (e) {
                    console.log('Audio alert not available');
                }
            }
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` :
                '0, 170, 0';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Stop camera on page load/refresh
            fetch('/page/loaded')
                .then(response => response.json())
                .then(data => {
                    console.log('üì± Page loaded - Camera stopped until user requests it');
                })
                .catch(error => {
                    console.log('Note: Camera control unavailable');
                });
            
            setupEventListeners();
            updateStats();
            setInterval(updateStats, 2000); // Update stats every 2 seconds
            
            // Start assistance monitoring
            updateAssistanceMetrics();
            setInterval(updateAssistanceMetrics, 3000);
        });

        // Stop camera when page is being refreshed or closed
        window.addEventListener('beforeunload', function() {
            fetch('/camera/stop')
                .then(() => {
                    console.log('üì± Camera stopped on page unload');
                })
                .catch(() => {
                    // Silent fail - page is closing anyway
                });
        });

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const videoUploadArea = document.getElementById('videoUploadArea');
            const videoInput = document.getElementById('videoInput');

            // Image drag and drop functionality
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (files[0].type.startsWith('image/')) {
                        handleFileSelect(files[0]);
                    }
                }
            });

            // Video drag and drop functionality
            videoUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                videoUploadArea.classList.add('dragover');
            });

            videoUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                videoUploadArea.classList.remove('dragover');
            });

            videoUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                videoUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    if (files[0].type.startsWith('video/')) {
                        handleVideoSelect(files[0]);
                    }
                }
            });

            // File input changes
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            videoInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleVideoSelect(e.target.files[0]);
                }
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function handleFileSelect(file) {
            selectedFile = file;
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">‚úÖ</div>
                <div class="upload-text">
                    Selected: ${file.name}<br>
                    <small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                </div>
            `;
        }

        function handleVideoSelect(file) {
            selectedVideo = file;
            const videoUploadArea = document.getElementById('videoUploadArea');
            videoUploadArea.innerHTML = `
                <div class="upload-icon">‚úÖ</div>
                <div class="upload-text">
                    Selected: ${file.name}<br>
                    <small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                </div>
            `;
        }

        function processUploadedImage() {
            if (!selectedFile) {
                showError('Please select an image first');
                return;
            }

            const loading = document.getElementById('uploadLoading');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = 'Processing image...';
            loading.style.display = 'block';

            const formData = new FormData();
            formData.append('file', selectedFile);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                if (data.success) {
                    showResults(data);
                    showSuccess(`Processing completed in ${data.processing_time}ms`);
                    
                    // Update assistance display if available
                    if (data.assistance) {
                        updateAssistanceAlert(data.assistance);
                        updateAssistanceMetrics(); // Refresh metrics
                    }
                } else {
                    showError(data.error || 'Processing failed');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                showError('Network error: ' + error.message);
            });
        }

        function processUploadedVideo() {
            if (!selectedVideo) {
                showError('Please select a video first');
                return;
            }

            const loading = document.getElementById('uploadLoading');
            const loadingText = document.getElementById('loadingText');
            const videoProgress = document.getElementById('videoProgress');
            
            loadingText.textContent = 'Processing video...';
            loading.style.display = 'block';
            videoProgress.style.display = 'block';

            const formData = new FormData();
            formData.append('file', selectedVideo);

            // Start progress simulation
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                updateProgress(progress);
            }, 500);

            fetch('/upload_video', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                updateProgress(100);
                
                setTimeout(() => {
                    loading.style.display = 'none';
                    videoProgress.style.display = 'none';
                    
                    if (data.success) {
                        showVideoResults(data);
                        showSuccess(`Video processing completed in ${data.total_time}s`);
                    } else {
                        showError(data.error || 'Video processing failed');
                    }
                }, 1000);
            })
            .catch(error => {
                clearInterval(progressInterval);
                loading.style.display = 'none';
                videoProgress.style.display = 'none';
                showError('Network error: ' + error.message);
            });
        }

        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percent + '%';
            progressText.textContent = `Processing video... ${Math.round(percent)}%`;
        }

        function startCamera() {
            document.getElementById('startCameraBtn').innerHTML = '‚è≥ Starting...';
            document.getElementById('startCameraBtn').disabled = true;
            
            fetch('/camera/start')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cameraActive = true;
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    document.getElementById('cameraFeed').style.display = 'block';
                    document.getElementById('cameraFeed').src = '/camera/feed';
                    document.getElementById('startCameraBtn').style.display = 'none';
                    document.getElementById('stopCameraBtn').style.display = 'inline-block';
                    showSuccess(data.message || 'Camera started successfully');
                } else {
                    document.getElementById('startCameraBtn').innerHTML = '‚ñ∂Ô∏è Start Camera';
                    document.getElementById('startCameraBtn').disabled = false;
                    showError(data.message || 'Failed to start camera');
                }
            })
            .catch(error => {
                document.getElementById('startCameraBtn').innerHTML = '‚ñ∂Ô∏è Start Camera';
                document.getElementById('startCameraBtn').disabled = false;
                showError('Camera error: ' + error.message);
            });
        }

        function stopCamera() {
            fetch('/camera/stop')
            .then(response => response.json())
            .then(data => {
                cameraActive = false;
                document.getElementById('cameraFeed').style.display = 'none';
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                document.getElementById('startCameraBtn').style.display = 'inline-block';
                document.getElementById('startCameraBtn').innerHTML = '‚ñ∂Ô∏è Start Camera';
                document.getElementById('startCameraBtn').disabled = false;
                document.getElementById('stopCameraBtn').style.display = 'none';
                showSuccess('Camera stopped - Click Start Camera to resume');
            })
            .catch(error => {
                showError('Error stopping camera: ' + error.message);
            });
        }

        function showResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsGrid = document.getElementById('resultsGrid');
            
            resultsGrid.innerHTML = `
                <div class="result-item">
                    <h3>üñºÔ∏è Original Image</h3>
                    <img class="result-image" src="${data.original_image}" alt="Original">
                </div>
                <div class="result-item">
                    <h3>üéØ Lane Mask</h3>
                    <img class="result-image" src="${data.mask_image}" alt="Mask">
                </div>
                <div class="result-item">
                    <h3>üõ£Ô∏è Lane Overlay</h3>
                    <img class="result-image" src="${data.overlay_image}" alt="Overlay">
                </div>
            `;

            document.getElementById('processingStats').innerHTML = `
                <div class="success">
                    <strong>Processing Results:</strong><br>
                    ‚è±Ô∏è Processing Time: ${data.processing_time}ms<br>
                    üõ£Ô∏è Lane Coverage: ${data.lane_coverage}%<br>
                    üéØ Confidence: ${data.confidence}%
                </div>
            `;

            resultsSection.style.display = 'block';
        }

        function showVideoResults(data) {
            console.log('Video processing response:', data);
            const resultsSection = document.getElementById('resultsSection');
            const resultsGrid = document.getElementById('resultsGrid');
            
            // Generate web-optimized video sources
            const processedVideoSources = [];
            if (data.web_optimized_video) {
                processedVideoSources.push(`<source src="${data.web_optimized_video}" type="video/mp4">`);
            }
            processedVideoSources.push(`<source src="${data.processed_video}" type="video/mp4">`);
            
            resultsGrid.innerHTML = `
                <div class="result-item">
                    <h3>üé• Original Video</h3>
                    <video class="video-player" controls preload="metadata" onerror="this.style.display='none'; this.nextElementSibling.nextElementSibling.style.display='block';">
                        <source src="${data.original_video}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="download-section" style="margin-top: 10px;">
                        <a href="${data.original_video.replace('/video/', '/download/')}" class="btn download-btn">üì• Download Original Video</a>
                    </div>
                    <div style="display:none; padding:20px; background:#fee; color:#c00; border-radius:8px; margin-top:10px;">
                        ‚ùå Could not load original video. Use the download button above instead.
                    </div>
                </div>
                <div class="result-item">
                    <h3>üõ£Ô∏è Lane Detection Video</h3>
                    <video class="video-player" controls preload="metadata" onerror="this.style.display='none'; this.nextElementSibling.nextElementSibling.style.display='block';">
                        ${processedVideoSources.join('')}
                        Your browser does not support the video tag.
                    </video>
                    <div class="download-section" style="margin-top: 10px;">
                        <a href="${data.processed_video.replace('/video/', '/download/')}" class="btn download-btn">üì• Download Processed Video</a>
                        ${data.web_optimized_video ? `<a href="${data.web_optimized_video.replace('/video/', '/download/')}" class="btn download-btn" style="margin-left:5px;">üì• Download Web Version</a>` : ''}
                    </div>
                    <div style="display:none; padding:20px; background:#fee; color:#c00; border-radius:8px; margin-top:10px;">
                        ‚ùå Could not load processed video. Use the download button above instead.
                    </div>
                </div>
            `;

            // Add event listeners for video loading debugging
            setTimeout(() => {
                const videos = resultsGrid.querySelectorAll('video');
                videos.forEach((video, index) => {
                    const videoType = index === 0 ? 'original' : 'processed';
                    
                    video.addEventListener('loadstart', () => {
                        console.log(`${videoType} video: Loading started`);
                    });
                    
                    video.addEventListener('loadedmetadata', () => {
                        console.log(`${videoType} video: Metadata loaded`);
                    });
                    
                    video.addEventListener('canplay', () => {
                        console.log(`${videoType} video: Can start playing`);
                    });
                    
                    video.addEventListener('error', (e) => {
                        console.error(`${videoType} video error:`, e);
                        console.error('Video src:', video.src);
                    });
                });
            }, 100);

            document.getElementById('processingStats').innerHTML = `
                <div class="success">
                    <strong>‚úÖ Video Processing Complete!</strong><br>
                    ‚è±Ô∏è Total Time: ${data.total_time}s<br>
                    üé¨ Frames Processed: ${data.frames_processed}<br>
                    üìà Average FPS: ${data.avg_fps}<br>
                    üõ£Ô∏è Average Lane Coverage: ${data.avg_lane_coverage}%<br>
                    ${data.web_optimized ? 'üåê Web Optimized: Browser-compatible version created' : 'üìÅ Standard Processing: Download for best compatibility'}<br><br>
                    <strong>üì• Direct Downloads:</strong><br>
                    <a href="${data.processed_video.replace('/video/', '/download/')}" class="btn download-btn" style="margin: 5px;">Download Processed Video</a>
                    <a href="${data.original_video.replace('/video/', '/download/')}" class="btn download-btn" style="margin: 5px;">Download Original</a>
                </div>
            `;

            resultsSection.style.display = 'block';
        }

        function updateStats() {
            fetch('/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('modelStatus').textContent = data.model_loaded ? '‚úÖ Ready' : '‚ùå Error';
                document.getElementById('totalProcessed').textContent = data.total_processed;
                document.getElementById('avgTime').textContent = data.avg_processing_time + 'ms';
                document.getElementById('lastTime').textContent = data.last_processing_time + 'ms';
            })
            .catch(error => {
                console.log('Stats update error:', error);
            });
        }

        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `‚ùå ${message}`;
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.querySelector('.container');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `‚úÖ ${message}`;
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>